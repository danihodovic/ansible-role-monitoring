---
- name: Create grafana dir
  file:
    path: '{{ grafana_dir }}'
    state: directory

- name: Create data sources dir
  file:
    path: '{{ grafana_provisioning_dir }}/datasources'
    state: directory
    recurse: true

- name: Create the data sources file
  copy:
    content: '{{ grafana_data_sources }}'
    dest: '{{ grafana_provisioning_dir }}/datasources/datasources.yml'

- name: Pull image
  docker_image:
    source: pull
    name: '{{ grafana_image }}'

- name: Start container
  docker_container: '{{ grafana_container_defaults | combine(grafana_container) }}'

- name: Health check grafana
  uri:
    url: http://localhost:9099/api/health
    status_code: 200
    timeout: 5
  register: health_check_grafana
  retries: 10
  delay: 1
  until: health_check_grafana.status == 200

- name: Wait for Grafana to start
  register: health_check_result
  # yamllint disable rule:line-length
  shell: >-
    docker exec -it {{ drone_worker_container.name }} sh -c
    'apk add --no-cache httpie && http http://localhost:{{ grafana_container.env.GF_SERVER_HTTP_PORT }}/api/health --check-status --timeout=3'
  retries: 10
  delay: 1
  until: health_check_result.rc == 0
